name: copilot-setup-steps.yml

# This workflow defines setup steps for GitHub Copilot to run before it performs tasks.
on:
    workflow_dispatch:
    push:
        paths:
            - .github/workflows/copilot-setup-steps.yml
    pull_request:
        paths:
            - .github/workflows/copilot-setup-steps.yml

env:
    # Model configuration - qwen2.5:1.5b supports tool calling (~1GB)
    OLLAMA_MODEL: qwen2.5:1.5b
    OLLAMA_HOST: http://localhost:11434

jobs:
    copilot-setup-steps:
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Cache Ollama models
            - name: Cache Ollama models
              uses:  actions/cache@v4
              id: ollama-cache
              with:
                  path: ~/.ollama
                  key: ollama-${{ env.OLLAMA_MODEL }}-${{ runner.os }}-v1
                  restore-keys: |
                      ollama-${{ env.OLLAMA_MODEL }}-${{ runner.os }}-

            # Install Ollama
            - name:  Install Ollama
              shell: bash
              run: |
                  curl -fsSL https://ollama.com/install.sh | sh
                  ollama --version

            # Start Ollama service with CORS enabled for browser access
            - name: Start Ollama service
              shell: bash
              run: |
                  # Start Ollama with CORS headers for browser testing
                  OLLAMA_ORIGINS="*" ollama serve &

                  # Wait for service to be ready
                  echo "Waiting for Ollama service..."
                  for i in {1..60}; do
                    if curl -s "${{ env.OLLAMA_HOST }}/api/tags" > /dev/null 2>&1; then
                      echo "Ollama service is ready!"
                      break
                    fi
                    if [ $i -eq 60 ]; then
                      echo "ERROR: Ollama service failed to start"
                      exit 1
                    fi
                    sleep 1
                  done

            # Pull model
            - name: Pull Ollama model
              shell: bash
              run: |
                  if ollama list 2>/dev/null | grep -q "${{ env.OLLAMA_MODEL }}"; then
                    echo "Model already cached"
                  else
                    echo "Pulling model..."
                    ollama pull ${{ env.OLLAMA_MODEL }}
                  fi
                  ollama list

            # Verify model
            - name: Verify Ollama model
              shell: bash
              run: |
                  echo "Running smoke test..."
                  ollama run ${{ env.OLLAMA_MODEL }} "Say OK" 2>&1 | head -5
                  echo "Model verified"

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'

            - name: Install dependencies
              shell: bash
              run: |
                  if [ -f package-lock.json ]; then
                    npm ci
                  else
                    npm install
                  fi

            # Install Playwright for browser testing
            - name: Install Playwright browsers
              shell: bash
              run: npx playwright install --with-deps chromium

            - name:  Verify Playwright
              shell: bash
              run:  npx playwright --version

            # Export environment for tests
            - name: Export test configuration
              shell: bash
              run: |
                  echo "OLLAMA_HOST=${{ env.OLLAMA_HOST }}" >> $GITHUB_ENV
                  echo "OLLAMA_MODEL=${{ env.OLLAMA_MODEL }}" >> $GITHUB_ENV
                  echo "VITE_OLLAMA_HOST=${{ env.OLLAMA_HOST }}" >> $GITHUB_ENV
                  echo "VITE_OLLAMA_MODEL=${{ env.OLLAMA_MODEL }}" >> $GITHUB_ENV
